<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Playlist Preview Browser — Old Spotify List Style</title>
<style>
  :root{
    --bg:#0f1114; --card:#121417; --muted:#9aa4b2; --accent:#1db954;
    --row-h:74px;
  }
  html,body{height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,#081018 0%, #0f1114 100%); color:#e6eef3; -webkit-font-smoothing:antialiased;}
  header{display:flex;align-items:center;gap:12px;padding:10px 12px;background:transparent; position:sticky; top:0; z-index:10;}
  header h1{font-size:16px;margin:0;font-weight:600}
  .container{max-width:980px;margin:0 auto;padding:8px;}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"]{padding:10px;border-radius:8px;border:1px solid #1f2933;background:#0b0d0f;color:#fff; min-width:220px; outline:none}
  button{padding:10px 12px;border-radius:9px;border:none;background:var(--accent);color:#fff;font-weight:600}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .status{font-size:13px;color:var(--muted);margin-left:8px}
  .playlist-info{display:flex;gap:12px;align-items:center;padding:12px 0}
  .cover{width:88px;height:88px;background:#0b0d0f;border-radius:8px;flex:0 0 88px;display:flex;align-items:center;justify-content:center}
  .pmeta{display:flex;flex-direction:column;gap:2px}
  .pmeta .title{font-size:18px;font-weight:700}
  .pmeta .sub{color:var(--muted);font-size:13px}
  .list{background:transparent; border-radius:8px;margin-top:8px}
  .row{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px; height:var(--row-h); cursor:pointer; background:transparent}
  .row:hover{background:rgba(255,255,255,0.02)}
  .row .art{width:54px;height:54px;flex:0 0 54px;border-radius:6px;overflow:hidden}
  .row .art img{width:100%;height:100%;object-fit:cover}
  .row .meta{flex:1;min-width:0}
  .row .meta .song{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row .meta .artist{color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row .controls{display:flex;gap:8px;align-items:center}
  .playbtn{width:42px;height:42px;border-radius:50%;display:grid;place-items:center;background:rgba(255,255,255,0.03);border:none;color:#fff}
  .playbtn.playing{background:var(--accent);color:#000}
  .small{font-size:12px;color:var(--muted)}
  .loader{padding:20px;text-align:center;color:var(--muted)}
  footer{padding:18px;color:var(--muted);text-align:center;font-size:13px}
  @media (max-width:520px){
    .container{padding:6px}
    .cover{width:72px;height:72px}
  }
</style>
</head>
<body>
<header class="container">
  <div style="flex:1">
    <h1>Playlist Preview Browser (Old List UI)</h1>
    <div class="small">Click any track to preview instantly — scroll freely.</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <div id="auth-status" class="status">Not signed in</div>
  </div>
</header>

<main class="container" id="app">
  <section class="controls" style="margin-bottom:6px">
    <input id="playlistUrl" placeholder="Paste Spotify playlist link (or playlist id)" />
    <button id="loadBtn">Load playlist</button>
    <button id="myPlaylistsBtn" class="ghost">Browse my playlists</button>
    <button id="signBtn" class="ghost">Sign in with Spotify</button>
  </section>

  <div id="playlistArea" style="display:none">
    <div class="playlist-info">
      <div class="cover" id="plistCover"></div>
      <div class="pmeta">
        <div class="title" id="plistTitle">Playlist Title</div>
        <div class="sub" id="plistOwner">by … · <span id="plistCount">0</span> tracks</div>
      </div>
    </div>

    <div id="list" class="list" aria-live="polite"></div>
    <div id="loader" class="loader" style="display:none">Loading…</div>
  </div>

  <div id="pickArea" style="display:none">
    <h3>Your playlists</h3>
    <div id="myLists"></div>
  </div>
</main>

<footer>
  Built for personal use. Spotify preview clips are provided by Spotify. If a track has no preview, a clip isn’t available.
</footer>

<script>
/* =========================
   CONFIG - REPLACE CLIENT_ID
   ========================= */
const CLIENT_ID = 'YOUR_SPOTIFY_CLIENT_ID_HERE'; // <<--- replace
const REDIRECT_URI = window.location.origin + '/'; // make sure this exact URL is in your Spotify app Redirect URIs
const SCOPES = 'playlist-read-private playlist-read-collaborative user-read-private'; // scopes used if you want to access user's playlists

/* =========================
   PKCE + Auth Helpers
   ========================= */
function generateRandomString(length) {
  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let text = '';
  for (let i = 0; i < length; i++) text += possible.charAt(Math.floor(Math.random() * possible.length));
  return text;
}
async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return new Uint8Array(hash);
}
function base64UrlEncode(bytes) {
  let str = btoa(String.fromCharCode(...bytes));
  return str.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}
async function pkceChallengeFromVerifier(v) {
  const hashed = await sha256(v);
  return base64UrlEncode(hashed);
}
function qs(obj){ return Object.entries(obj).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&'); }

/* =========================
   App State
   ========================= */
let accessToken = null;
let refreshToken = null;
let codeVerifier = null;
let audio = new Audio();
let currentPlayingId = null;
let allTracks = []; // stores {track, preview_url}
let nextFetch = null;
let playlistIdGlobal = null;
let isFetching = false;

/* =========================
   UI refs
   ========================= */
const playlistUrlInput = document.getElementById('playlistUrl');
const loadBtn = document.getElementById('loadBtn');
const listEl = document.getElementById('list');
const loaderEl = document.getElementById('loader');
const plistTitle = document.getElementById('plistTitle');
const plistOwner = document.getElementById('plistOwner');
const plistCount = document.getElementById('plistCount');
const plistCover = document.getElementById('plistCover');
const authStatus = document.getElementById('auth-status');
const signBtn = document.getElementById('signBtn');
const myPlaylistsBtn = document.getElementById('myPlaylistsBtn');
const pickArea = document.getElementById('pickArea');
const myLists = document.getElementById('myLists');

/* =========================
   Auth flow (PKCE)
   ========================= */
async function startAuth() {
  codeVerifier = generateRandomString(64);
  const challenge = await pkceChallengeFromVerifier(codeVerifier);
  sessionStorage.setItem('code_verifier', codeVerifier);
  const state = generateRandomString(12);
  sessionStorage.setItem('pkce_state', state);
  const params = {
    client_id: CLIENT_ID,
    response_type: 'code',
    redirect_uri: REDIRECT_URI,
    code_challenge_method: 'S256',
    code_challenge: challenge,
    state,
    scope: SCOPES
  };
  const authUrl = 'https://accounts.spotify.com/authorize?' + qs(params);
  window.location = authUrl;
}
async function handleRedirectCallback() {
  const url = new URL(window.location.href);
  const code = url.searchParams.get('code');
  const state = url.searchParams.get('state');
  const error = url.searchParams.get('error');
  if (error) {
    console.error('Auth error', error);
    return;
  }
  if (!code) return;
  const savedState = sessionStorage.getItem('pkce_state');
  if (!savedState || savedState !== state) {
    console.error('Invalid state');
    return;
  }
  const verifier = sessionStorage.getItem('code_verifier');
  if (!verifier) return;
  // Exchange code for token
  const body = {
    grant_type: 'authorization_code',
    code,
    redirect_uri: REDIRECT_URI,
    client_id: CLIENT_ID,
    code_verifier: verifier
  };
  const resp = await fetch('https://accounts.spotify.com/api/token', {
    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:qs(body)
  });
  const data = await resp.json();
  if (data.error) { console.error('Token error', data); return; }
  accessToken = data.access_token;
  // store minimal token
  sessionStorage.setItem('sp_access_token', accessToken);
  history.replaceState({}, document.title, REDIRECT_URI); // clear querystring
  updateAuthUI();
}

/* =========================
   Misc helpers
   ========================= */
function setStatus(msg){ authStatus.textContent = msg; }
function clearList(){ listEl.innerHTML = ''; allTracks=[]; playlistIdGlobal = null; plistTitle.textContent='Playlist Title'; plistOwner.textContent=''; plistCount.textContent='0'; plistCover.innerHTML='';}
function extractPlaylistId(urlOrId){
  if(!urlOrId) return null;
  // Accept playlist URL or id
  try{
    const u = new URL(urlOrId);
    const parts = u.pathname.split('/');
    const idx = parts.indexOf('playlist');
    if(idx>=0 && parts[idx+1]) return parts[idx+1];
  }catch(e){}
  // if looks like id
  if(urlOrId.match(/^[0-9A-Za-z_-]{22,}$/)) return urlOrId;
  return null;
}

/* =========================
   Spotify API calls
   ========================= */
async function apiGet(url){
  const h = { 'Accept':'application/json' };
  if(accessToken) h['Authorization'] = 'Bearer ' + accessToken;
  const r = await fetch(url, { headers:h });
  if(r.status===401){ // token expired / missing
    sessionStorage.removeItem('sp_access_token');
    accessToken = null;
    updateAuthUI();
    throw new Error('Unauthorized - please sign in again');
  }
  return await r.json();
}

async function fetchPlaylistMetadata(playlistId){
  const url = `https://api.spotify.com/v1/playlists/${playlistId}`;
  return await apiGet(url);
}

async function fetchPlaylistTracksPaged(playlistId, offset=0, limit=100){
  const url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?offset=${offset}&limit=${limit}&fields=items(track(id,name,artists,album(name,images),preview_url,uri)),total,next`;
  return await apiGet(url);
}

async function fetchAllTracksAppend(playlistId){
  if(isFetching) return;
  isFetching = true;
  loaderEl.style.display='block';
  try{
    let offset = allTracks.length;
    const page = await fetchPlaylistTracksPaged(playlistId, offset, 100);
    if(!page.items) return;
    const items = page.items;
    for(const it of items){
      if(!it.track) continue;
      allTracks.push(it.track);
      appendRow(it.track, allTracks.length-1);
    }
    // update count
    plistCount.textContent = allTracks.length;
    if(page.next){
      // still more - we'll fetch further on scroll (lazy)
      nextFetch = () => fetchAllTracksAppend(playlistId);
    } else {
      nextFetch = null;
    }
  } catch(err){
    console.error(err);
    alert('Error fetching tracks: '+(err.message||err));
  } finally {
    isFetching = false;
    loaderEl.style.display = 'none';
  }
}

/* =========================
   Render & UI
   ========================= */
function appendRow(track, index){
  const row = document.createElement('div');
  row.className = 'row';
  row.dataset.index = index;
  const art = document.createElement('div'); art.className='art';
  const img = document.createElement('img');
  const image = (track.album && track.album.images && track.album.images[0]) ? track.album.images[0].url : '';
  img.src = image;
  img.alt = track.name;
  art.appendChild(img);

  const meta = document.createElement('div'); meta.className='meta';
  const song = document.createElement('div'); song.className='song'; song.textContent = track.name;
  const artist = document.createElement('div'); artist.className='artist'; artist.textContent = track.artists.map(a=>a.name).join(', ');
  meta.appendChild(song); meta.appendChild(artist);

  const ctrls = document.createElement('div'); ctrls.className='controls';
  const playBtn = document.createElement('button'); playBtn.className='playbtn'; playBtn.title='Play preview';
  playBtn.innerHTML = '&#9658;';
  if(!track.preview_url) { playBtn.disabled=true; playBtn.title='No preview available'; playBtn.style.opacity=0.45; }
  ctrls.appendChild(playBtn);

  const timeNote = document.createElement('div'); timeNote.className='small'; timeNote.textContent = track.preview_url ? 'preview' : '—';
  ctrls.appendChild(timeNote);

  row.appendChild(art); row.appendChild(meta); row.appendChild(ctrls);
  listEl.appendChild(row);

  // click handlers
  row.addEventListener('click', (e)=>{
    // avoid double firing when clicking button - unified behavior: clicking a row triggers preview
    playTrackAtIndex(index, row, playBtn);
  });
  playBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    playTrackAtIndex(index, row, playBtn);
  });
}

function setPlayingClass(rowEl, playing){
  const btn = rowEl.querySelector('.playbtn');
  if(!btn) return;
  if(playing) btn.classList.add('playing'), btn.innerHTML = '&#9208;'; // pause icon
  else btn.classList.remove('playing'), btn.innerHTML = '&#9658;';
}

async function playTrackAtIndex(index, rowEl, playBtn){
  const t = allTracks[index];
  if(!t) return;
  if(!t.preview_url){
    // nice UX: try fetch a fallback small preview via oembed? (no)
    alert('No preview available for this track.');
    return;
  }
  // if clicked same track -> toggle pause
  if(currentPlayingId === t.id){
    if(!audio.paused){ audio.pause(); setPlayingClass(rowEl,false); currentPlayingId = null; return; }
  }
  // stop old
  const oldRow = document.querySelector('.row.playing-row');
  if(oldRow){ oldRow.classList.remove('playing-row'); setPlayingClass(oldRow,false); }
  audio.pause();
  audio = new Audio(t.preview_url);
  audio.crossOrigin = "anonymous";
  audio.play().catch(err=>console.warn('play failed',err));
  currentPlayingId = t.id;
  rowEl.classList.add('playing-row');
  setPlayingClass(rowEl,true);
  // when done
  audio.onended = ()=>{ rowEl.classList.remove('playing-row'); setPlayingClass(rowEl,false); currentPlayingId = null; };
  audio.onpause = ()=>{ setPlayingClass(rowEl,false); };
}

/* =========================
   Infinite scroll (lazy fetch)
   ========================= */
let scrollObserver = null;
function setupScrollObserver(){
  if(scrollObserver) scrollObserver.disconnect();
  const sentinel = document.createElement('div');
  sentinel.id = 'scroll-sentinel';
  sentinel.style.padding = '20px';
  listEl.appendChild(sentinel);
  scrollObserver = new IntersectionObserver(entries=>{
    for(const e of entries){
      if(e.isIntersecting && nextFetch && !isFetching){
        nextFetch();
      }
    }
  },{root:null,rootMargin:'200px'});
  scrollObserver.observe(sentinel);
}

/* =========================
   Load logic
   ========================= */
loadBtn.addEventListener('click', async ()=>{
  const id = extractPlaylistId(playlistUrlInput.value.trim());
  if(!id){ alert('Paste a valid Spotify playlist URL or ID.'); return; }
  clearList();
  playlistIdGlobal = id;
  document.getElementById('playlistArea').style.display='block';
  pickArea.style.display='none';
  loaderEl.style.display='block';
  try{
    const meta = await fetchPlaylistMetadata(id);
    plistTitle.textContent = meta.name || 'Playlist';
    plistOwner.textContent = `by ${meta.owner?.display_name || meta.owner?.id || 'unknown' } · `;
    plistCount.textContent = meta.tracks?.total || '0';
    if(meta.images && meta.images[0]) plistCover.innerHTML = `<img src="${meta.images[0].url}" style="width:100%;height:100%;object-fit:cover;border-radius:6px" />`;
    // fetch first page and setup lazy
    await fetchAllTracksAppend(id);
    setupScrollObserver();
  } catch(err){
    console.error(err); alert('Error loading playlist');
  } finally { loaderEl.style.display='none'; }
});

/* =========================
   Browse user's playlists
   ========================= */
myPlaylistsBtn.addEventListener('click', async ()=>{
  if(!accessToken){ alert('Please sign in with Spotify to browse your playlists'); return; }
  pickArea.style.display='block';
  document.getElementById('playlistArea').style.display='none';
  myLists.innerHTML = 'Loading…';
  try{
    let items = [];
    let url = 'https://api.spotify.com/v1/me/playlists?limit=50';
    while(url){
      const data = await apiGet(url);
      items = items.concat(data.items || []);
      url = data.next;
    }
    myLists.innerHTML = '';
    items.forEach(p=>{
      const b = document.createElement('button');
      b.textContent = `${p.name} — ${p.tracks.total} tracks`;
      b.style.display='block';
      b.style.width='100%';
      b.style.margin='6px 0';
      b.addEventListener('click', ()=>{
        playlistUrlInput.value = p.id;
        loadBtn.click();
      });
      myLists.appendChild(b);
    });
  } catch(err){
    console.error(err);
    myLists.innerHTML = 'Failed to load playlists.';
  }
});

/* =========================
   Sign in / Auth UI
   ========================= */
signBtn.addEventListener('click', ()=> startAuth());
function updateAuthUI(){
  const saved = sessionStorage.getItem('sp_access_token');
  accessToken = saved || accessToken;
  if(accessToken){
    setStatus('Signed in');
    signBtn.style.display='none';
    myPlaylistsBtn.style.display='inline-block';
  } else {
    setStatus('Not signed in');
    signBtn.style.display='inline-block';
    myPlaylistsBtn.style.display='none';
  }
}

/* =========================
   Init: check callback + token
   ========================= */
(async function init(){
  // if code present in URL -> handle
  await handleRedirectCallback().catch(()=>{});
  // restore token if present
  const saved = sessionStorage.getItem('sp_access_token');
  if(saved) accessToken = saved;
  updateAuthUI();
})();

/* =========================
   Keyboard: space toggles pause
   ========================= */
window.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){ e.preventDefault(); if(audio.paused) audio.play().catch(()=>{}); else audio.pause(); }
});
</script>
</body>
</html>
